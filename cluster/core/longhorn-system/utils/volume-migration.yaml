# Handy template to migrate data from NFS to longhorn volume.
---
apiVersion: batch/v1
kind: Job
metadata:
  namespace: home # namespace where the pvc's exist
  name: data-config-restore
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 3
  template:
    metadata:
      name: volume-migration
      labels:
        name: volume-migration
    spec:
      restartPolicy: Never
      containers:
        - name: volume-migration
          image: ubuntu:jammy
          tty: true
          command: ["/bin/sh"]
          args: ["-c", "cp -r -v /mnt/old/. /mnt/new"]
          volumeMounts:
            - name: old-vol
              mountPath: /mnt/old
            - name: new-vol
              mountPath: /mnt/new
      volumes:
        - name: old-vol
          persistentVolumeClaim:
            claimName: data-source-pvc # change to data source pvc
        - name: new-vol
          persistentVolumeClaim:
            claimName: baikal-data # change to data target pvc
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: data-source-pv
  namespace: media
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: nfs-csi
  mountOptions:
    - nconnect=8 # only supported on linux kernel version >= 5.3
    - hard
    - nfsvers=4.1
  csi:
    driver: nfs.csi.k8s.io
    readOnly: false
    volumeHandle: data-source-pv-id
    volumeAttributes:
      server: 192.168.1.128
      share: /volume1/shared/code/baikal/data
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: data-source-pvc
  namespace: home
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  volumeName: data-source-pv
  storageClassName: nfs-csi
