---
version: "3"

vars:
  SYSTEM_UPGRADE_KUBERNETES: '{{.KUBERNETES_DIR}}/apps/system-upgrade/tuppr/upgrades/kubernetes.yaml'
  SYSTEM_UPGRADE_TALOS: '{{.KUBERNETES_DIR}}/apps/system-upgrade/tuppr/upgrades/talos.yaml'

env:
  KUBERNETES_VERSION:
    sh: yq '.spec.kubernetes.version | select(.)' {{.SYSTEM_UPGRADE_KUBERNETES}}
  TALOS_VERSION:
    sh: yq '.spec.talos.version | select(.)' {{.SYSTEM_UPGRADE_TALOS}}

tasks:

  apply-node:
    desc: Apply Talos config to a node [NODE=required] [MODE=auto]
    cmd: |-
      minijinja-cli {{.TALOS_DIR}}/{{.MACHINE_TYPE}}.yaml | op inject \
        | talosctl --nodes {{.NODE}} apply-config {{if eq .INSECURE "true"}}--insecure{{end}} \
          --mode {{.MODE}} \
          --config-patch @{{.TALOS_DIR}}/{{.MACHINE_TYPE}}/{{.NODE}}.yaml \
          --file /dev/stdin
    vars:
      MODE: '{{.MODE | default "auto"}}'
      INSECURE:
        sh: talosctl --nodes {{.NODE}} get machineconfig &> /dev/null && echo false || echo true
      MACHINE_TYPE:
        sh: |-
          talosctl --nodes {{.NODE}} get machinetypes --output=jsonpath='{.spec}' 2> /dev/null \
            || basename $(find '{{.TALOS_DIR}}' -name '{{.NODE}}.yaml' -printf '%h')
    env:
      TALOS_SCHEMATIC:
        sh: |-
          curl --silent -X POST --data-binary @{{.TALOS_DIR}}/schematic.yaml https://factory.talos.dev/schematics \
            | jq --raw-output '.id'
    requires:
      vars: [NODE]
    preconditions:
      - op user get --me
      - talosctl config info
      - test -f {{.TALOS_DIR}}/{{.MACHINE_TYPE}}.yaml
      - test -f {{.TALOS_DIR}}/{{.MACHINE_TYPE}}/{{.NODE}}.yaml
      - which minijinja-cli op talosctl

  upgrade-node:
    desc: Upgrade Talos on a single node [NODE=required]
    cmd: talosctl --nodes {{.NODE}} upgrade --image=factory.talos.dev/metal-installer-secureboot/{{ .TALOS_SCHEMATIC }}:{{ .VERSION }} --timeout=10m
    vars:
      MACHINE_TYPE:
        sh: talosctl --nodes {{.NODE}} get machinetypes --output=jsonpath='{.spec}'
      TALOS_SCHEMATIC:
        sh: |-
          curl --silent -X POST --data-binary @{{.TALOS_DIR}}/schematic.yaml https://factory.talos.dev/schematics \
            | jq --raw-output '.id'
    requires:
      vars: [NODE, VERSION]
    preconditions:
      - talosctl config info
      - talosctl --nodes {{.NODE}} get machineconfig
      - which minijinja-cli talosctl yq

  upgrade-k8s:
    desc: Upgrade Kubernetes across the whole cluster
    cmd: talosctl --nodes {{.RANDOM_CONTROLLER}} upgrade-k8s --to $KUBERNETES_VERSION
    vars:
      RANDOM_CONTROLLER:
        sh: talosctl config info --output json | jq --raw-output '.endpoints[]' | shuf -n 1
    preconditions:
      - talosctl config info
      - talosctl --nodes {{.RANDOM_CONTROLLER}} get machineconfig
      - which jq talosctl

  reboot-node:
    desc: Reboot Talos on a single node [NODE=required] [MODE=default]
    cmd: talosctl --nodes {{.NODE}} reboot --mode={{.MODE}}
    vars:
      MODE: '{{.MODE | default "default"}}'
    requires:
      vars: [NODE]
    preconditions:
      - talosctl config info
      - talosctl --nodes {{.NODE}} get machineconfig
      - which talosctl

  shutdown-cluster:
    desc: Shutdown Talos across the whole cluster
    prompt: Shutdown the Talos cluster ... continue?
    cmd: talosctl --nodes {{.NODES}} shutdown --force
    vars:
      NODES:
        sh: talosctl config info --output json | jq --join-output '[.nodes[]] | join(",")'
    preconditions:
      - talosctl config info
      - talosctl --nodes {{.NODES}} get machineconfig
      - which jq talosctl

  reset-node:
    desc: Reset Talos on a single node [NODE=required]
    prompt: Reset Talos node '{{.NODE}}' ... continue?
    cmd: talosctl --nodes {{.NODE}} reset --graceful=false
    requires:
      vars: [NODE]
    preconditions:
      - talosctl config info
      - talosctl --nodes {{.NODE}} get machineconfig
      - which talosctl

  reset-cluster:
    desc: Reset Talos across the whole cluster
    prompt: Reset the Talos cluster ... continue?
    cmd: talosctl --nodes {{.NODES}} reset --graceful=false
    vars:
      NODES:
        sh: talosctl config info --output json | jq --join-output '[.nodes[]] | join(",")'
    preconditions:
      - talosctl config info
      - talosctl --nodes {{.NODES}} get machineconfig
      - which jq talosctl

  kubeconfig:
    desc: Generate the kubeconfig for a Talos cluster
    cmd: talosctl kubeconfig --nodes {{.RANDOM_CONTROLLER}} --force {{.KUBERNETES_DIR}}
    vars:
      RANDOM_CONTROLLER:
        sh: talosctl config info --output json | jq --raw-output '.endpoints[]' | shuf -n 1
    preconditions:
      - talosctl config info
      - talosctl --nodes {{.RANDOM_CONTROLLER}} get machineconfig
      - which jq talosctl

  regen-certs:
    desc: Regenerate Talos admin client certificates using machine CA from 1Password
    prompt: Regenerate Talos admin client certificates ... continue?
    cmds:
      - |
        TMPDIR=$(mktemp -d)
        trap "rm -rf $TMPDIR" EXIT
        echo "Extracting machine CA from 1Password..."
        MACHINE_CA_CRT=$(op read "op://${ONEPASSWORD_VAULT}/talos/MACHINE_CA_CRT" | tr -d '\n')
        MACHINE_CA_KEY=$(op read "op://${ONEPASSWORD_VAULT}/talos/MACHINE_CA_KEY" | tr -d '\n')
        printf '%s' "$MACHINE_CA_CRT" | base64 -d > "$TMPDIR/ca.crt"
        printf '%s' "$MACHINE_CA_KEY" | base64 -d > "$TMPDIR/ca.key"
        echo "Generating new admin key, CSR, and certificate..."
        cd "$TMPDIR"
        talosctl gen key --name admin
        talosctl gen csr --key admin.key --ip 127.0.0.1
        talosctl gen crt --ca ca --csr admin.csr --name admin
        echo "Assembling new talosconfig..."
        ADMIN_CRT=$(base64 < admin.crt | tr -d '\n')
        ADMIN_KEY=$(base64 < admin.key | tr -d '\n')
        printf 'context: k8s\ncontexts:\n  k8s:\n    endpoints:\n      - 10.0.40.2\n    ca: %s\n    crt: %s\n    key: %s\n' \
          "$MACHINE_CA_CRT" "$ADMIN_CRT" "$ADMIN_KEY" > "{{.TALOS_DIR}}/talosconfig"
        echo "Verifying new talosconfig..."
        talosctl config info
    preconditions:
      - op user get --me
      - which op talosctl base64
