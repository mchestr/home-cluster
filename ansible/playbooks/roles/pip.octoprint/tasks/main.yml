---
- name: Install prerequisites for octoprint plugins
  ansible.builtin.apt:
    name: "{{ item }}"
    install_recommends: false
  register: apt_install_common
  retries: 5
  loop: "{{ apt_packages_to_install | default([]) }}"
  until: apt_install_common is success

- name: Install octoprint plugins
  tags:
    - skip_ansible_lint
  ansible.builtin.pip:
    name: "{{ item }}"
    virtualenv: "/home/{{ octoprint_user }}/Octoprint/venv"
    virtualenv_command: virtualenv
    state: latest
  loop: "{{ python_packages_to_install | default([]) }}"
  notify: Restart octoprint

- name: Copy users.yaml
  ansible.builtin.template:
    src: users.yaml.j2
    dest: "/home/{{ octoprint_user }}/.octoprint/users.yaml"
    mode: 0755
  notify: Restart octoprint
