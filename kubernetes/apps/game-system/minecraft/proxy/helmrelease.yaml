---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: minecraft-proxy
spec:
  interval: 5m
  chart:
    spec:
      chart: minecraft-proxy
      version: 3.5.0
      sourceRef:
        kind: HelmRepository
        name: itzg-minecraft-charts
        namespace: flux-system
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    strategyType: Recreate
    resources:
      requests:
        memory: 512Mi
        cpu: 500m
      limits:
        memory: 2048Mi
        cpu: 1
    securityContext:
      runAsUser: 5506
      fsGroup: 5506
    minecraftProxy:
      type: BUNGEECORD
      onlineMode: false
      memory: 1024M
      serviceType: LoadBalancer
      loadBalancerIP: 192.168.100.233
      # loadBalancerSourceRanges: []
      ## Set the externalTrafficPolicy in the Service to either Cluster or Local
      # externalTrafficPolicy: Cluster
      # externalIPs:
      configFilePath: /server/config.yml
      # This can be set to the contents of your config file (only works with yaml currently)
      config: |
        player_limit: -1
        ip_forward: true
        permissions:
          default:
            - bungeecord.command.server
            - bungeecord.command.list
          admin:
            - bungeecord.command.alert
            - bungeecord.command.end
            - bungeecord.command.ip
            - bungeecord.command.reload
        timeout: 30000
        log_pings: true
        log_commands: false
        online_mode: true
        servers:
          vanilla:
            motd: 'MCraft - Vanilla'
            address: minecraft-vanilla-minecraft.game-system.svc.cluster.local:25565
            restricted: false
        listeners:
          - query_port: 25577
            motd: '&1Minecraft in K8s'
            priorities:
              - vanilla
            bind_local_address: true
            tab_list: GLOBAL_PING
            query_enabled: false
            host: 0.0.0.0:25577
            forced_hosts:
              mc-vanilla.chestr.dev: vanilla
            max_players: 20
            tab_size: 60
            ping_passthrough: false
            force_default_server: true
            proxy_protocol: false
            default_server: vanilla
        disabled_commands:
          - disabledcommandhere
        network_compression_threshold: 256
        groups:
          mchestr:
            - admin
        connection_throttle: 4000
        connection_throttle_limit: 3
        stats: f2876aa6-74d2-468c-90ee-1377111f1caa
        forge_support: false
        inject_commands: false
      rcon:
        # If you enable this, make SURE to change your password below.
        enabled: false
        # loadBalancerSourceRanges: []
        ## Set the externalTrafficPolicy in the Service to either Cluster or Local
        # externalTrafficPolicy: Cluster
      extraPorts: []
    extraEnv:
      VELOCITY_VERSION: 3.3.0-SNAPSHOT
      VELOCITY_BUILD_ID: "335"
    persistence:
      dataDir:
        enabled: true
        existingClaim: ${VOLSYNC_CLAIM}
    podAnnotations: {}
    deploymentAnnotations:
      reloader.stakater.com/auto: "true"
    serviceAnnotations:
      external-dns.alpha.kubernetes.io/hostname: mc.chestr.dev
    rconServiceAnnotations: {}
    # Can allow plugins access to the kubernetes api using a service account
    # https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/
    serviceAccountName:

  valuesFrom:
    - kind: Secret
      name: minecraft-vanilla-secret
      valuesKey: RCON_PASSWORD
      targetPath: minecraftProxy.rcon.password
