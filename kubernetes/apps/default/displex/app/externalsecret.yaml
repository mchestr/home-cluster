---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &app displex
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: displex-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        displex.toml: |
          application_name = "MFlix"

          [database]
          type = "PostgreSQL"
          username = "{{ .DISPLEX_STORAGE_POSTGRES_USERNAME }}"
          password = "{{ .DISPLEX_STORAGE_POSTGRES_PASSWORD }}"
          port = 5432
          database = "displex"
          host = "postgres16-rw.default.svc.cluster.local"

          [http]
          hostname = "displex.chestr.dev"

          [discord]
          client_id = {{ .MIKEFLIX_APPLICATION_CLIENT_ID }}
          client_secret = "{{ .MIKEFLIX_APPLICATION_CLIENT_SECRET }}"
          server_id = {{ .SERVER_ID }}

          [discord_bot]
          token = "{{ .MIKEFLIX_APPLICATION_BOT_TOKEN }}"
          status_text = "MFlix"

          [plex]
          server_id = "{{ .DISPLEX_PLEX_SERVER_ID }}"

          [tautulli]
          url = "http://tautulli.default.svc.cluster.local:8181"
          api_key = "{{ .TAUTULLI_API_KEY }}"

          [overseerr]
          url = "http://overseerr.default.svc.cluster.local:5055"
          api_key = "{{ .OVERSEERR_API_KEY }}"

          [session]
          secret_key = "{{ .DISPLEX_SESSION_SECRET_KEY }}"

          [discord_bot.stat_update.stats_category]
          name = "MFlix Status"
          stream_name = "Current Streams"
          transcode_name = "Current Transcodes"
          bandwidth_total_name = "Bandwidth"
          bandwidth_remote_name = "Bandwidth"

          [discord_bot.stat_update.library_category]
          name = "MFlix Library"
          movies_name = "ðŸŽ¥ Movies"
          tv_shows_name = "ðŸ“º TV Shows"
          tv_episodes_name = "ðŸ§© Episodes"

          [requests_config.overrides]
          "{{ .DISPLEX_OVERRIDE_USER_1_NAME }}" = { name = "override", watch_hours = -1, tv = { quota_limit = 0, quota_days = 0 }, movie = { quota_limit = 0, quota_days = 0 }}

  dataFrom:
    - extract:
        key: *app
    - extract:
        key: cloudnative-pg
    - extract:
        key: tautulli
    - extract:
        key: discord-mflix
    - extract:
        key: overseerr
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: displex-dbinit
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: displex-dbinit-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        INIT_POSTGRES_DBNAME: displex
        INIT_POSTGRES_HOST: postgres16-rw.default.svc.cluster.local
        INIT_POSTGRES_USER: "{{ .DISPLEX_STORAGE_POSTGRES_USERNAME }}"
        INIT_POSTGRES_PASS: "{{ .DISPLEX_STORAGE_POSTGRES_PASSWORD }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
  dataFrom:
    - extract:
        key: cloudnative-pg
