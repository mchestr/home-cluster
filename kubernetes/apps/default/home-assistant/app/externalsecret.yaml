---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &app home-assistant
  namespace: default
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: home-assistant-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Home Assistant
        HASS_COUNTRY: CA
        HASS_PROVINCE: BC
        HASS_DATABASE_URL: postgresql://{{ .HASS_STORAGE_POSTGRES_USERNAME }}:{{ .HASS_STORAGE_POSTGRES_PASSWORD }}@postgres16-rw.default.svc.cluster.local/home-assistant
        HASS_GOOGLE_CLIENT_ID: "{{ .HASS_GOOGLE_CLIENT_ID }}"
        HASS_GOOGLE_CLIENT_SECRET: "{{ .HASS_GOOGLE_CLIENT_SECRET }}"
        HASS_GOOGLE_PUBSUB_TOPIC: "{{ .HASS_GOOGLE_PUBSUB_TOPIC }}"
        HASS_GOOGLE_PROJECT_ID: "{{ .HASS_GOOGLE_PROJECT_ID }}"
        HASS_GOOGLE_ASSISTANT_PROJECT_ID: "{{ .HASS_GOOGLE_ASSISTANT_PROJECT_ID }}"
        HASS_CAT_CAMERA_STREAM_SOURCE: "{{ .HASS_CAT_CAMERA_STREAM_SOURCE }}"
        HASS_CAT_CAMERA_DEVICE_ID: "{{ .HASS_CAT_CAMERA_DEVICE_ID }}"
        HASS_ALARM_CONTROL_PANEL_CODE: "{{ .HASS_ALARM_CONTROL_PANEL_CODE }}"
        HASS_WASTE_COLLECTION_SCHEDULE_ICS_URL: "{{ .HASS_WASTE_COLLECTION_SCHEDULE_ICS_URL }}"
  dataFrom:
    - extract:
        key: *app
    - extract:
        key: cloudnative-pg
    - extract:
        key: cameras
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: home-assistant-deploykey
  namespace: default
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: home-assistant-deploykey-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        id_ed25519.pub: "{{ .HASS_PUBLIC_DEPLOYKEY }}"
        id_ed25519: "{{ .HASS_DEPLOYKEY }}"
  dataFrom:
    - extract:
        key: home-assistant
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: home-assistant-dbinit
  namespace: default
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: home-assistant-dbinit-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        INIT_POSTGRES_DBNAME: home-assistant
        INIT_POSTGRES_HOST: postgres16-rw.default.svc.cluster.local
        INIT_POSTGRES_USER: "{{ .HASS_STORAGE_POSTGRES_USERNAME }}"
        INIT_POSTGRES_PASS: "{{ .HASS_STORAGE_POSTGRES_PASSWORD }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
  dataFrom:
    - extract:
        key: cloudnative-pg
