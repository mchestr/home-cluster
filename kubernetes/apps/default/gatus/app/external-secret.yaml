---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &app gatus
  namespace: default
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  dataFrom:
    - extract:
        key: pushover
    - extract:
        key: cluster
  target:
    name: *app
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        config.yaml: |
          default-alerts: &default-alerts
            alerts:
              - type: pushover
                failure-threshold: 3
                success-threshold: 5
                send-on-resolved: true
                description: "healthcheck failed"
          default-endpoint: &default-endpoint
            interval: 15m
            group: core
            <<: *default-alerts
            conditions:
              - "[STATUS] == 200"
              - "[RESPONSE_TIME] < 500"
              - "[BODY] != pat(*auth.{{ .CLUSTER_DOMAIN }}*)"
          default-authelia-endpoint: &default-authelia-endpoint
            <<: *default-endpoint
            group: authelia
            conditions:
              - "[STATUS] == 200"
              - "[RESPONSE_TIME] < 500"
              - "[BODY] == pat(*auth.{{ .CLUSTER_DOMAIN }}*)"

          alerting:
            pushover:
              application-token: "{{ .PUSHOVER_GATUS_TOKEN }}"
              user-key: "{{ .PUSHOVER_USER_KEY }}"
          endpoints:
            - name: Alert Manager
              <<: *default-authelia-endpoint
              url: https://alert-manager.{{ .CLUSTER_DOMAIN }}
            - name: AppDaemon
              <<: *default-authelia-endpoint
              url: https://appdaemon.{{ .CLUSTER_DOMAIN }}
            - name: AppDaemon Code
              <<: *default-authelia-endpoint
              url: https://appdaemon-code.{{ .CLUSTER_DOMAIN }}
            - name: Bazarr
              <<: *default-authelia-endpoint
              url: https://bazarr.{{ .CLUSTER_DOMAIN }}
            - name: EMQX
              <<: *default-authelia-endpoint
              url: https://emqx.{{ .CLUSTER_DOMAIN }}
            - name: ESPHome
              <<: *default-authelia-endpoint
              url: https://esphome.{{ .CLUSTER_DOMAIN }}
            - name: Grafana
              <<: *default-authelia-endpoint
              url: https://grafana.{{ .CLUSTER_DOMAIN }}
            - name: Home
              <<: *default-endpoint
              url: https://home.{{ .CLUSTER_DOMAIN }}
            - name: Home Assistant
              <<: *default-endpoint
              url: https://home-assistant.{{ .CLUSTER_DOMAIN }}
            - name: Home Assistant Code
              <<: *default-authelia-endpoint
              url: https://home-assistant-code.{{ .CLUSTER_DOMAIN }}
            - name: Jellyfin
              <<: *default-endpoint
              url: https://jellyfin.{{ .CLUSTER_DOMAIN }}
            - name: Lidarr
              <<: *default-authelia-endpoint
              url: https://lidarr.{{ .CLUSTER_DOMAIN }}
            - name: LochNAS
              <<: *default-endpoint
              url: https://lochnas.{{ .CLUSTER_DOMAIN }}
            - name: Mainsail
              <<: *default-endpoint
              url: https://mainsail.{{ .CLUSTER_DOMAIN }}
            - name: Minio
              <<: *default-endpoint
              url: https://minio.{{ .CLUSTER_DOMAIN }}
            - name: Overseerr
              <<: *default-endpoint
              url: https://overseerr.{{ .CLUSTER_DOMAIN }}
            - name: Paperless
              <<: *default-authelia-endpoint
              url: https://paperless.{{ .CLUSTER_DOMAIN }}
            - name: Immich
              <<: *default-endpoint
              url: https://immich.{{ .CLUSTER_DOMAIN }}
            - name: Plex
              <<: *default-endpoint
              url: https://plex.{{ .CLUSTER_DOMAIN }}
            - name: Prometheus
              <<: *default-authelia-endpoint
              url: https://prometheus.{{ .CLUSTER_DOMAIN }}
            - name: Prowlarr
              <<: *default-authelia-endpoint
              url: https://prowlarr.{{ .CLUSTER_DOMAIN }}
            - name: qBittorrent
              <<: *default-authelia-endpoint
              url: https://qbittorrent.{{ .CLUSTER_DOMAIN }}
            - name: Rook Ceph
              <<: *default-endpoint
              url: https://rook-ceph.{{ .CLUSTER_DOMAIN }}
            - name: SabNZBD
              <<: *default-authelia-endpoint
              url: https://sabnzbd.{{ .CLUSTER_DOMAIN }}
            - name: Sonarr
              <<: *default-authelia-endpoint
              url: https://sonarr.{{ .CLUSTER_DOMAIN }}
            - name: Tautulli
              <<: *default-authelia-endpoint
              url: https://tautulli.{{ .CLUSTER_DOMAIN }}
            - name: Thanos
              <<: *default-authelia-endpoint
              url: https://thanos.{{ .CLUSTER_DOMAIN }}
            - name: Unifi
              <<: *default-endpoint
              url: https://unifi.{{ .CLUSTER_DOMAIN }}
            - name: Zigbee
              <<: *default-authelia-endpoint
              url: https://zigbee2mqtt.{{ .CLUSTER_DOMAIN }}
            - name: zWave
              <<: *default-authelia-endpoint
              url: https://zwave-js-ui.{{ .CLUSTER_DOMAIN }}
