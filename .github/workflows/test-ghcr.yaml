---
name: Test GHCR Access

on:
  workflow_dispatch:

jobs:
  test:
    name: Test GHCR Authentication
    runs-on: ubuntu-latest
    steps:
      - name: Generate Token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
          repositories: home-cluster,homerp

      - name: Test Docker Login
        run: |
          echo "${{ steps.app-token.outputs.token }}" | docker login ghcr.io -u x-access-token --password-stdin
          echo "Docker login successful"

      - name: Test Pull Private Image
        run: |
          docker pull ghcr.io/mchestr/homerp/backend:latest
          echo "Pull successful"

      - name: Test with owner scope
        id: app-token-owner
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Test Docker Login (owner scope)
        run: |
          docker logout ghcr.io
          echo "${{ steps.app-token-owner.outputs.token }}" | docker login ghcr.io -u x-access-token --password-stdin
          echo "Docker login with owner scope successful"

      - name: Test Pull with owner scope
        run: |
          docker pull ghcr.io/mchestr/homerp/backend:latest
          echo "Pull with owner scope successful"
