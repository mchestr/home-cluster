---
name: Test GHCR Access

on:
  workflow_dispatch:

jobs:
  test:
    name: Test GHCR Authentication
    runs-on: ubuntu-latest
    steps:
      # Test 1: repositories scope
      - name: Generate Token (repositories scope)
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token-repos
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
          repositories: home-cluster,homerp

      - name: Test Pull (repositories scope)
        continue-on-error: true
        run: |
          echo "${{ steps.app-token-repos.outputs.token }}" | docker login ghcr.io -u x-access-token --password-stdin
          docker pull ghcr.io/mchestr/homerp/backend:latest && echo "SUCCESS: repositories scope works" || echo "FAILED: repositories scope"

      # Test 2: owner scope
      - name: Generate Token (owner scope)
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token-owner
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Test Pull (owner scope)
        continue-on-error: true
        run: |
          docker logout ghcr.io || true
          echo "${{ steps.app-token-owner.outputs.token }}" | docker login ghcr.io -u x-access-token --password-stdin
          docker pull ghcr.io/mchestr/homerp/backend:latest && echo "SUCCESS: owner scope works" || echo "FAILED: owner scope"

      # Test 3: GITHUB_TOKEN (built-in)
      - name: Test Pull (GITHUB_TOKEN)
        continue-on-error: true
        run: |
          docker logout ghcr.io || true
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker pull ghcr.io/mchestr/homerp/backend:latest && echo "SUCCESS: GITHUB_TOKEN works" || echo "FAILED: GITHUB_TOKEN"

      - name: Summary
        run: |
          echo "Check the steps above to see which authentication method works."
          echo "If none work, verify package settings at:"
          echo "https://github.com/users/mchestr/packages/container/homerp%2Fbackend/settings"
